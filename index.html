<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pay Allocator</title>
<style>
  :root {
    --bg:#0e0e12;--surface:#16161e;--surface2:#1e1e2a;--border:#2a2a3a;
    --accent:#a78bfa;--accent2:#7c3aed;--text:#e8e8f0;--muted:#7070a0;
    --green:#34d399;--yellow:#fbbf24;--red:#f87171;--blue:#60a5fa;
    --radius:14px;--radius-sm:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;}
  #login-screen{width:100%;max-width:380px;padding:2rem;text-align:center;}
  .lock-icon{font-size:2.5rem;margin-bottom:1rem;display:block;}
  .app-title{font-size:1.6rem;font-weight:700;letter-spacing:-.03em;background:linear-gradient(135deg,var(--accent),#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.4rem;}
  .app-sub{color:var(--muted);font-size:.85rem;margin-bottom:2rem;}
  .login-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;}
  .field-label{display:block;font-size:.75rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:.5rem;text-align:left;}
  input[type=password],input[type=text],input[type=number],input[type=date],select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:1rem;padding:.75rem 1rem;outline:none;transition:border-color .2s;-webkit-appearance:none;}
  input:focus,select:focus{border-color:var(--accent);}
  .btn{display:block;width:100%;padding:.85rem;border-radius:var(--radius-sm);border:none;font-size:.95rem;font-weight:600;cursor:pointer;transition:opacity .15s,transform .1s;}
  .btn:active{transform:scale(.98);opacity:.85;}
  .btn-primary{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;margin-top:1.2rem;}
  .btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text);margin-top:.75rem;}
  .btn-danger{background:var(--surface2);border:1px solid #3a1a1a;color:var(--red);margin-top:.5rem;font-size:.8rem;padding:.6rem;}
  .error-msg{color:var(--red);font-size:.8rem;margin-top:.6rem;min-height:1.1em;}
  #app{display:none;width:100%;max-width:600px;padding:1.5rem 1rem 4rem;min-height:100vh;}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border);}
  .header-title{font-size:1.2rem;font-weight:700;background:linear-gradient(135deg,var(--accent),#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .logout-btn{background:none;border:1px solid var(--border);color:var(--muted);font-size:.75rem;padding:.3rem .75rem;border-radius:20px;cursor:pointer;}
  .tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:.35rem;}
  .tab{flex:1;padding:.6rem;border-radius:var(--radius-sm);border:none;background:none;color:var(--muted);font-size:.82rem;font-weight:600;cursor:pointer;transition:background .2s,color .2s;}
  .tab.active{background:var(--surface2);color:var(--text);}
  .tab-content{display:none;}.tab-content.active{display:block;}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem;}
  .card-title{font-size:.7rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:1.1rem;}
  .form-row{margin-bottom:1rem;}.form-row:last-child{margin-bottom:0;}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
  .amount-input-wrap{position:relative;}
  .amount-prefix{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--accent);font-weight:700;font-size:1.1rem;pointer-events:none;}
  .amount-big{font-size:1.6rem!important;font-weight:700!important;padding-left:1.8rem!important;letter-spacing:-.02em;}
  .alloc-grid{display:grid;gap:.6rem;margin-top:.5rem;}
  .alloc-row{display:flex;align-items:center;background:var(--surface2);border-radius:var(--radius-sm);padding:.85rem 1rem;border:1px solid var(--border);}
  .alloc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-right:.75rem;}
  .alloc-label{flex:1;font-size:.88rem;}
  .alloc-pct{font-size:.75rem;color:var(--muted);margin-right:.75rem;}
  .alloc-amount{font-weight:700;font-size:1rem;min-width:80px;text-align:right;}
  .total-row{display:flex;justify-content:space-between;padding:.75rem 1rem 0;margin-top:.25rem;border-top:1px solid var(--border);}
  .total-label{color:var(--muted);font-size:.85rem;}.total-amount{font-weight:700;font-size:1rem;}
  .split-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin:1rem 0 .25rem;gap:2px;}
  .split-seg{height:100%;border-radius:3px;transition:width .4s ease;}
  .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:.6rem 0;}
  .toggle-label{font-size:.88rem;}
  .toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
  .toggle input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;inset:0;background:var(--surface2);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:background .2s;}
  .toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:2px;top:50%;transform:translateY(-50%);background:var(--muted);border-radius:50%;transition:transform .2s,background .2s;}
  input:checked+.toggle-slider{background:var(--accent2);border-color:var(--accent2);}
  input:checked+.toggle-slider:before{transform:translateX(20px) translateY(-50%);background:#fff;}
  .agency-fields{display:none;margin-top:.75rem;}.agency-fields.show{display:grid;gap:.75rem;}
  .log-empty{text-align:center;padding:2.5rem 1rem;color:var(--muted);font-size:.88rem;}
  .log-entry{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.2rem;margin-bottom:.75rem;cursor:pointer;transition:border-color .2s;}
  .log-entry:hover{border-color:var(--accent);}
  .log-entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;}
  .log-show-name{font-weight:600;font-size:.95rem;}.log-amount{font-weight:700;font-size:1.05rem;color:var(--accent);}
  .log-meta{font-size:.75rem;color:var(--muted);display:flex;gap:.75rem;flex-wrap:wrap;}
  .log-tag{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:.1rem .4rem;font-size:.7rem;color:var(--muted);}
  .log-tag.agency{color:var(--yellow);border-color:#3a3010;background:#1e1a08;}
  .log-tag.oos{color:var(--blue);border-color:#0f2040;background:#080f20;}
  .log-alloc-mini{display:flex;gap:.4rem;margin-top:.6rem;flex-wrap:wrap;}
  .mini-pill{font-size:.7rem;padding:.15rem .5rem;border-radius:4px;font-weight:600;}
  .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem;margin-bottom:1rem;}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;text-align:center;}
  .stat-val{font-size:1.2rem;font-weight:700;color:var(--accent);}
  .stat-lbl{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:.2rem;}
  .settings-row{display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border);}
  .settings-row:last-child{border-bottom:none;}
  .pct-input{width:70px!important;text-align:center;font-weight:700;}
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:1rem;}
  .modal-overlay.show{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;}
  .modal-close{background:none;border:none;color:var(--muted);font-size:1.3rem;cursor:pointer;}
  .notion-export-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;font-family:monospace;font-size:.78rem;white-space:pre-wrap;word-break:break-all;color:var(--muted);max-height:300px;overflow-y:auto;cursor:pointer;}
  .notion-export-box:hover{border-color:var(--accent);}
  @media(max-width:400px){.two-col{grid-template-columns:1fr;}.stats-row{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<div id="login-screen">
  <span class="lock-icon">üîê</span>
  <div class="app-title">Pay Allocator</div>
  <div class="app-sub">Performer Finance Dashboard</div>
  <div class="login-card">
    <label class="field-label">Password</label>
    <input type="password" id="pw-input" placeholder="Enter your password">
    <p class="error-msg" id="pw-error"></p>
    <button class="btn btn-primary" onclick="tryLogin()">Unlock</button>
  </div>
</div>

<div id="app">
  <div class="header">
    <div class="header-title">üí∏ Pay Allocator</div>
    <button class="logout-btn" onclick="logout()">Lock</button>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('allocate',this)">Allocate</button>
    <button class="tab" onclick="switchTab('log',this)">Log</button>
    <button class="tab" onclick="switchTab('settings',this)">Settings</button>
  </div>

  <div class="tab-content active" id="tab-allocate">
    <div class="card">
      <div class="card-title">Show Payment</div>
      <div class="form-row">
        <label class="field-label">Amount Received</label>
        <div class="amount-input-wrap">
          <span class="amount-prefix">$</span>
          <input type="number" id="show-amount" class="amount-big" placeholder="0.00" min="0" step="0.01" oninput="recalculate()">
        </div>
      </div>
      <div class="two-col">
        <div class="form-row">
          <label class="field-label">Show Name / Client</label>
          <input type="text" id="show-name" placeholder="e.g. Acme Corp Event">
        </div>
        <div class="form-row">
          <label class="field-label">Show Date</label>
          <input type="date" id="show-date">
        </div>
      </div>
      <div class="form-row">
        <div class="toggle-row">
          <span class="toggle-label">Out-of-State Show</span>
          <label class="toggle"><input type="checkbox" id="oos-toggle" onchange="oosChange()"><span class="toggle-slider"></span></label>
        </div>
        <div id="oos-note" style="display:none;font-size:.75rem;color:var(--muted);margin-top:.3rem;">‚ö†Ô∏è Out-of-state shows may require filing in that state. Consult your tax advisor.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Agency / Commission</div>
      <div class="toggle-row">
        <span class="toggle-label">Agency Involved?</span>
        <label class="toggle"><input type="checkbox" id="agency-toggle" onchange="toggleAgency()"><span class="toggle-slider"></span></label>
      </div>
      <div class="agency-fields" id="agency-fields">
        <div>
          <label class="field-label">Agency Name</label>
          <input type="text" id="agency-name" placeholder="e.g. G.L. Berg Entertainment">
        </div>
        <div>
          <label class="field-label">Commission Structure</label>
          <select id="agency-mode" onchange="toggleAgencyMode()">
            <option value="already_deducted">Already deducted ‚Äî amount above is my net</option>
            <option value="pct_owe">I owe commission % ‚Äî calculate from gross above</option>
            <option value="flat_owe">I owe a flat commission amount</option>
          </select>
        </div>
        <div id="agency-pct-field" style="display:none">
          <label class="field-label">Commission %</label>
          <input type="number" id="agency-pct" placeholder="15" min="0" max="50" step="0.5" oninput="recalculate()">
        </div>
        <div id="agency-flat-field" style="display:none">
          <label class="field-label">Flat Commission Amount</label>
          <div class="amount-input-wrap">
            <span class="amount-prefix">$</span>
            <input type="number" id="agency-flat" placeholder="0.00" min="0" step="0.01" oninput="recalculate()" style="padding-left:1.8rem!important;">
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="breakdown-card" style="display:none">
      <div class="card-title">Allocation Breakdown</div>
      <div id="agency-summary" style="display:none;margin-bottom:1rem;padding:.75rem;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid #3a3010;">
        <div style="display:flex;justify-content:space-between;font-size:.82rem;">
          <span style="color:var(--yellow)">Agency Commission</span>
          <span id="agency-summary-amount" style="font-weight:700;color:var(--yellow)"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.75rem;margin-top:.3rem;">
          <span style="color:var(--muted)">Your allocatable net</span>
          <span id="net-display" style="color:var(--muted);font-weight:600;"></span>
        </div>
      </div>
      <div class="split-bar" id="split-bar"></div>
      <div class="alloc-grid" id="alloc-grid"></div>
      <div class="total-row">
        <span class="total-label">Total Allocated</span>
        <span class="total-amount" id="total-allocated">$0.00</span>
      </div>
      <button class="btn btn-primary" style="margin-top:1.2rem;" onclick="saveEntry()">Save to Log</button>
    </div>
  </div>

  <div class="tab-content" id="tab-log">
    <div class="stats-row" id="stats-row"></div>
    <div id="log-list"><div class="log-empty">No entries yet.</div></div>
    <div id="log-actions" style="display:none;margin-top:.5rem;">
      <button class="btn btn-secondary" onclick="exportNotion()">üìã Copy Notion-Ready Log</button>
      <button class="btn btn-danger" onclick="clearLog()">Clear All Entries</button>
    </div>
  </div>

  <div class="tab-content" id="tab-settings">
    <div class="card">
      <div class="card-title">Allocation Buckets</div>
      <div id="buckets-editor"></div>
      <button class="btn btn-secondary" style="margin-top:1rem;" onclick="addBucket()">+ Add Bucket</button>
    </div>
    <div class="card">
      <div class="card-title">Minnesota Self-Employment Tax Info</div>
      <div style="font-size:.82rem;color:var(--muted);line-height:1.7;">
        Your tax bucket uses a <strong style="color:var(--text)">blended self-employment estimate</strong>:<br><br>
        ‚Ä¢ <strong style="color:var(--text)">SE Tax (Federal):</strong> ~15.3% on 92.35% of net (both halves)<br>
        ‚Ä¢ <strong style="color:var(--text)">Federal Income Tax:</strong> Estimated bracket withholding<br>
        ‚Ä¢ <strong style="color:var(--text)">MN State Income:</strong> ~5‚Äì9.85% progressive<br>
        ‚Ä¢ <strong style="color:var(--text)">Recommended set-aside:</strong> 30‚Äì35% total<br><br>
        <span style="color:var(--red);font-size:.75rem;">‚ö†Ô∏è Estimate only. Out-of-state shows may trigger nexus. Consult a tax professional.</span>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Notion Integration</div>
      <div style="font-size:.82rem;color:var(--muted);line-height:1.6;">After saving entries, go to the <strong style="color:var(--text)">Log tab</strong> and tap <strong style="color:var(--text)">"Copy Notion-Ready Log"</strong>. It generates a Markdown table ‚Äî paste it directly into any Notion page.</div>
    </div>
    <div class="card">
      <div class="card-title">Change Password</div>
      <div class="form-row"><label class="field-label">Current Password</label><input type="password" id="pw-current" placeholder="Current password"></div>
      <div class="form-row"><label class="field-label">New Password</label><input type="password" id="pw-new" placeholder="Min 4 characters"></div>
      <div class="form-row"><label class="field-label">Confirm New</label><input type="password" id="pw-confirm" placeholder="Confirm new password"></div>
      <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
      <p class="error-msg" id="pw-change-msg"></p>
    </div>
    <div class="card">
      <div class="card-title">Data Backup</div>
      <button class="btn btn-secondary" onclick="exportData()">Export All Data (JSON)</button>
      <button class="btn btn-danger" onclick="importDataPrompt()">Import / Restore Backup</button>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
    </div>
  </div>
</div>

<div class="modal-overlay" id="entry-modal">
  <div class="modal">
    <div class="modal-header">
      <div style="font-weight:700;font-size:1rem;" id="modal-title">Entry Detail</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div id="modal-body"></div>
    <button class="btn btn-danger" id="modal-delete-btn" style="margin-top:1rem;">Delete Entry</button>
  </div>
</div>

<div class="modal-overlay" id="notion-modal">
  <div class="modal">
    <div class="modal-header">
      <div style="font-weight:700;font-size:1rem;">üìã Notion-Ready Log</div>
      <button class="modal-close" onclick="closeNotionModal()">√ó</button>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:.75rem;">Click the box to copy, then paste into Notion.</div>
    <div class="notion-export-box" id="notion-export-box" onclick="copyNotionExport()"></div>
    <button class="btn btn-primary" style="margin-top:1rem;" onclick="copyNotionExport()">Copy to Clipboard</button>
    <p id="notion-copy-msg" style="text-align:center;font-size:.8rem;color:var(--green);margin-top:.5rem;"></p>
  </div>
</div>

<script>
const STORAGE_KEY='pay_allocator_v2';
const COLORS=['#a78bfa','#34d399','#fbbf24','#60a5fa','#f472b6','#fb923c','#e879f9','#2dd4bf'];
const DEFAULT_BUCKETS=[
  {id:'taxes',name:'Taxes (MN SE)',pct:33,color:'#f87171'},
  {id:'biz',name:'Business Expenses',pct:15,color:'#fbbf24'},
  {id:'savings',name:'Savings',pct:20,color:'#34d399'},
  {id:'retire',name:'Retirement',pct:10,color:'#60a5fa'},
  {id:'reserve',name:'Show Reserve Fund',pct:10,color:'#a78bfa'},
  {id:'take',name:'Take-Home Pay',pct:12,color:'#fb923c'},
];
function hashStr(s){let h=0x811c9dc5;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h*0x01000193)>>>0;}return h.toString(16);}
let state=(()=>{try{const r=localStorage.getItem(STORAGE_KEY);if(r)return JSON.parse(r);}catch(e){}return{pwHash:hashStr('showtime'),buckets:DEFAULT_BUCKETS,log:[]};})();
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
function fmt(n){return'$'+n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){if(!d)return'';const p=d.split('-');const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return`${m[parseInt(p[1])-1]} ${parseInt(p[2])}, ${p[0]}`;}

function tryLogin(){
  const v=document.getElementById('pw-input').value;
  if(!v){document.getElementById('pw-error').textContent='Enter your password';return;}
  if(hashStr(v)===state.pwHash){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('pw-error').textContent='';
    document.getElementById('pw-input').value='';
    document.getElementById('show-date').valueAsDate=new Date();
    renderLog();renderBuckets();
  }else{document.getElementById('pw-error').textContent='Incorrect password';document.getElementById('pw-input').value='';}
}
document.getElementById('pw-input').addEventListener('keydown',e=>{if(e.key==='Enter')tryLogin();});
function logout(){document.getElementById('app').style.display='none';document.getElementById('login-screen').style.display='block';document.getElementById('show-amount').value='';document.getElementById('breakdown-card').style.display='none';}
function changePassword(){
  const cur=document.getElementById('pw-current').value,nw=document.getElementById('pw-new').value,con=document.getElementById('pw-confirm').value,msg=document.getElementById('pw-change-msg');
  if(hashStr(cur)!==state.pwHash){msg.style.color='var(--red)';msg.textContent='Current password incorrect';return;}
  if(nw.length<4){msg.style.color='var(--red)';msg.textContent='Min 4 characters';return;}
  if(nw!==con){msg.style.color='var(--red)';msg.textContent='Passwords do not match';return;}
  state.pwHash=hashStr(nw);save();msg.style.color='var(--green)';msg.textContent='‚úì Password updated!';
  ['pw-current','pw-new','pw-confirm'].forEach(id=>document.getElementById(id).value='');
  setTimeout(()=>{msg.textContent='';},3000);
}
function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');document.getElementById('tab-'+name).classList.add('active');
  if(name==='log')renderLog();if(name==='settings')renderBuckets();
}
function oosChange(){document.getElementById('oos-note').style.display=document.getElementById('oos-toggle').checked?'block':'none';}
function toggleAgency(){const on=document.getElementById('agency-toggle').checked;document.getElementById('agency-fields').classList[on?'add':'remove']('show');toggleAgencyMode();recalculate();}
function toggleAgencyMode(){const m=document.getElementById('agency-mode').value;document.getElementById('agency-pct-field').style.display=m==='pct_owe'?'block':'none';document.getElementById('agency-flat-field').style.display=m==='flat_owe'?'block':'none';recalculate();}
function recalculate(){
  const raw=parseFloat(document.getElementById('show-amount').value)||0;
  if(raw<=0){document.getElementById('breakdown-card').style.display='none';return;}
  const agOn=document.getElementById('agency-toggle').checked,agMode=document.getElementById('agency-mode').value;
  let fee=0,net=raw;
  if(agOn){if(agMode==='pct_owe'){fee=raw*((parseFloat(document.getElementById('agency-pct').value)||0)/100);net=raw-fee;}else if(agMode==='flat_owe'){fee=parseFloat(document.getElementById('agency-flat').value)||0;net=raw-fee;}}
  const agSum=document.getElementById('agency-summary');
  if(agOn&&fee>0){agSum.style.display='block';document.getElementById('agency-summary-amount').textContent=fmt(fee);document.getElementById('net-display').textContent=fmt(net);}else{agSum.style.display='none';}
  const tp=state.buckets.reduce((s,b)=>s+b.pct,0);
  const allocs=state.buckets.map(b=>({...b,amount:net*(b.pct/100)}));
  document.getElementById('split-bar').innerHTML=allocs.map(a=>`<div class="split-seg" style="width:${tp>0?a.pct/tp*100:0}%;background:${a.color}"></div>`).join('');
  document.getElementById('alloc-grid').innerHTML=allocs.map(a=>`<div class="alloc-row"><div class="alloc-dot" style="background:${a.color}"></div><div class="alloc-label">${a.name}</div><div class="alloc-pct">${a.pct}%</div><div class="alloc-amount" style="color:${a.color}">${fmt(a.amount)}</div></div>`).join('');
  const tot=allocs.reduce((s,a)=>s+a.amount,0);
  const el=document.getElementById('total-allocated');el.textContent=fmt(tot);el.style.color=Math.abs(tp-100)>0.5?'var(--yellow)':'var(--text)';
  document.getElementById('breakdown-card').style.display='block';
  window._calc={raw,fee,net,allocs};
}
function saveEntry(){
  const c=window._calc;if(!c)return;
  const e={id:Date.now().toString(),date:document.getElementById('show-date').value||new Date().toISOString().split('T')[0],showName:document.getElementById('show-name').value||'Show',rawAmount:c.raw,agencyFee:c.fee,agencyName:document.getElementById('agency-toggle').checked?(document.getElementById('agency-name').value||''):'',agencyMode:document.getElementById('agency-toggle').checked?document.getElementById('agency-mode').value:'',net:c.net,oos:document.getElementById('oos-toggle').checked,allocs:c.allocs.map(a=>({id:a.id,name:a.name,pct:a.pct,amount:a.amount,color:a.color})),savedAt:new Date().toISOString()};
  state.log.unshift(e);save();
  const btn=document.querySelector('#breakdown-card .btn-primary'),orig=btn.textContent;
  btn.textContent='‚úì Saved!';btn.style.background='var(--green)';
  setTimeout(()=>{btn.textContent=orig;btn.style.background='';},2000);
}
function renderLog(){
  const list=document.getElementById('log-list'),actions=document.getElementById('log-actions'),stats=document.getElementById('stats-row');
  if(!state.log.length){list.innerHTML='<div class="log-empty">No entries yet. Allocate a show payment to start your log.</div>';actions.style.display='none';stats.innerHTML='';return;}
  actions.style.display='block';
  const tg=state.log.reduce((s,e)=>s+e.rawAmount,0),tt=state.log.reduce((s,e)=>{const a=e.allocs.find(a=>a.id==='taxes');return s+(a?a.amount:0);},0);
  stats.innerHTML=`<div class="stat-card"><div class="stat-val">${state.log.length}</div><div class="stat-lbl">Shows</div></div><div class="stat-card"><div class="stat-val" style="font-size:.9rem">${fmt(tg)}</div><div class="stat-lbl">Gross Earned</div></div><div class="stat-card"><div class="stat-val" style="font-size:.9rem;color:var(--red)">${fmt(tt)}</div><div class="stat-lbl">Tax Set-Aside</div></div>`;
  list.innerHTML=state.log.map(e=>`<div class="log-entry" onclick="openEntry('${e.id}')"><div class="log-entry-header"><span class="log-show-name">${e.showName}</span><span class="log-amount">${fmt(e.rawAmount)}</span></div><div class="log-meta"><span>${fmtDate(e.date)}</span>${e.agencyName?`<span class="log-tag agency">üè¢ ${e.agencyName}</span>`:''} ${e.oos?'<span class="log-tag oos">‚úàÔ∏è OOS</span>':''} ${e.agencyFee>0?`<span class="log-tag agency">Commission: ${fmt(e.agencyFee)}</span>`:''}</div><div class="log-alloc-mini">${e.allocs.slice(0,4).map(a=>`<span class="mini-pill" style="background:${a.color}20;color:${a.color}">${a.name.split(' ')[0]}: ${fmt(a.amount)}</span>`).join('')}</div></div>`).join('');
}
function openEntry(id){
  const e=state.log.find(x=>x.id===id);if(!e)return;
  document.getElementById('modal-title').textContent=e.showName;
  document.getElementById('modal-delete-btn').onclick=()=>deleteEntry(id);
  document.getElementById('modal-body').innerHTML=`<div style="font-size:.8rem;color:var(--muted);margin-bottom:1rem;">${fmtDate(e.date)}${e.oos?' ¬∑ ‚úàÔ∏è Out of State':''}</div>${e.agencyFee>0?`<div style="background:var(--surface2);border:1px solid #3a3010;border-radius:var(--radius-sm);padding:.75rem;margin-bottom:.75rem;font-size:.85rem;"><div style="color:var(--yellow);font-weight:600;margin-bottom:.25rem;">Agency: ${e.agencyName||'‚Äî'}</div><div style="display:flex;justify-content:space-between;"><span style="color:var(--muted)">Gross Paid</span><span>${fmt(e.rawAmount)}</span></div><div style="display:flex;justify-content:space-between;"><span style="color:var(--muted)">Commission</span><span style="color:var(--yellow)">- ${fmt(e.agencyFee)}</span></div><div style="display:flex;justify-content:space-between;margin-top:.3rem;border-top:1px solid var(--border);padding-top:.3rem;"><span style="color:var(--muted)">Your Net</span><span style="font-weight:700;">${fmt(e.net)}</span></div></div>`:''}<div class="alloc-grid">${e.allocs.map(a=>`<div class="alloc-row"><div class="alloc-dot" style="background:${a.color}"></div><div class="alloc-label">${a.name}</div><div class="alloc-pct">${a.pct}%</div><div class="alloc-amount" style="color:${a.color}">${fmt(a.amount)}</div></div>`).join('')}</div><div class="total-row"><span class="total-label">Net Allocated</span><span class="total-amount">${fmt(e.net)}</span></div>`;
  document.getElementById('entry-modal').classList.add('show');
}
function deleteEntry(id){if(!confirm('Delete this entry?'))return;state.log=state.log.filter(e=>e.id!==id);save();closeModal();renderLog();}
function closeModal(){document.getElementById('entry-modal').classList.remove('show');}
function clearLog(){if(!confirm('Clear all entries? Cannot be undone.'))return;state.log=[];save();renderLog();}
function exportNotion(){
  if(!state.log.length)return;
  const hd=['Date','Show','Gross','Agency','Net',...state.buckets.map(b=>b.name),'OOS'];
  const rows=state.log.map(e=>[fmtDate(e.date),e.showName,fmt(e.rawAmount),e.agencyFee>0?`${e.agencyName||''} (${fmt(e.agencyFee)})`:'‚Äî',fmt(e.net),...state.buckets.map(b=>{const a=e.allocs.find(x=>x.id===b.id);return a?fmt(a.amount):'‚Äî';}),e.oos?'Yes':'No']);
  let md='| '+hd.join(' | ')+' |\n'+'| '+hd.map(()=>'---').join(' | ')+' |\n';
  rows.forEach(r=>{md+='| '+r.join(' | ')+' |\n';});
  const tot=['**Totals**','',fmt(state.log.reduce((s,e)=>s+e.rawAmount,0)),'',fmt(state.log.reduce((s,e)=>s+e.net,0)),...state.buckets.map(b=>fmt(state.log.reduce((s,e)=>{const a=e.allocs.find(x=>x.id===b.id);return s+(a?a.amount:0);},0))),''];
  md+='| '+tot.join(' | ')+' |\n';
  document.getElementById('notion-export-box').textContent=md;
  document.getElementById('notion-modal').classList.add('show');
}
function copyNotionExport(){const t=document.getElementById('notion-export-box').textContent;navigator.clipboard.writeText(t).then(()=>{document.getElementById('notion-copy-msg').textContent='‚úì Copied!';setTimeout(()=>{document.getElementById('notion-copy-msg').textContent='';},3000);}).catch(()=>{document.getElementById('notion-copy-msg').textContent='Select and copy manually.';});}
function closeNotionModal(){document.getElementById('notion-modal').classList.remove('show');}
function renderBuckets(){
  const c=document.getElementById('buckets-editor');c.innerHTML='';
  state.buckets.forEach((b,i)=>{const row=document.createElement('div');row.className='settings-row';row.innerHTML=`<div style="display:flex;align-items:center;gap:.6rem;flex:1;min-width:0;"><div style="width:12px;height:12px;border-radius:50%;background:${b.color};flex-shrink:0;"></div><input type="text" value="${b.name}" style="flex:1;min-width:0;font-size:.85rem;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:.4rem .6rem;" onchange="upBucket(${i},'name',this.value)"></div><div style="display:flex;align-items:center;gap:.4rem;margin-left:.75rem;flex-shrink:0;"><input type="number" value="${b.pct}" min="0" max="100" style="width:56px!important;font-size:.85rem;padding:.4rem!important;text-align:center;font-weight:700;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);" onchange="upBucket(${i},'pct',parseFloat(this.value)||0)"><span style="color:var(--muted);font-size:.85rem;">%</span><button onclick="rmBucket(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:.2rem;line-height:1;">√ó</button></div>`;c.appendChild(row);});
}
function upBucket(i,key,val){state.buckets[i][key]=val;save();recalculate();}
function rmBucket(i){if(state.buckets.length<=1)return;state.buckets.splice(i,1);save();renderBuckets();recalculate();}
function addBucket(){const idx=state.buckets.length;state.buckets.push({id:'bucket_'+Date.now(),name:'New Bucket',pct:0,color:COLORS[idx%COLORS.length]});save();renderBuckets();}
function exportData(){const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='pay_allocator_backup.json';a.click();URL.revokeObjectURL(url);}
function importDataPrompt(){document.getElementById('import-file').click();}
function importData(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){try{const data=JSON.parse(e.target.result);if(data.buckets&&data.log!==undefined){state=data;save();renderLog();renderBuckets();alert('Data restored successfully!');}else{alert('Invalid backup file.');}}catch(err){alert('Error reading file.');}};reader.readAsText(file);event.target.value='';}
</script>
</body>
</html>
